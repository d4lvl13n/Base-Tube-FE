# Wallet Linking Flow Audit Report

| Requirement (from spec) | Status (✅/⚠️/❌) | File/Line Evidence | Risk Notes |
| --- | --- | --- | --- |
| Guard `useWeb3Auth` auto-connect when Clerk-authenticated or intent is `link`/`transaction` (Solution 2) | ❌ | `src/hooks/useWeb3Auth.ts:180`, `src/hooks/useWeb3Auth.ts:183`, `src/hooks/useWeb3Auth.ts:191` | Auto-connect ignores intent and only checks `auth_method`; Clerk users without `auth_method='clerk'` can still be auto-signed up as Web3, causing account duplication. |
| Use auth-aware connect wrapper + persist wallet intent (`useAuthAwareWallet`, `wallet_connect_intent`) before opening the modal (Solution 1) | ❌ | `src/components/common/Profile/PendingPassesClaim.tsx:293`, `src/pages/CheckoutSuccessPage.tsx:564`, `src/hooks/useAuthAwareWallet.ts` | No intent tracking; linking vs sign-in is indistinguishable, so Web3 login can trigger during linking/transaction flows. |
| Post-connection linking for Clerk users in PendingPassesClaim (Solution 3) | ✅ | `src/components/common/Profile/PendingPassesClaim.tsx:152`, `src/components/common/Profile/PendingPassesClaim.tsx:163`, `src/components/common/Profile/PendingPassesClaim.tsx:167` | Works, but still races with auto-connect if Clerk detection fails. |
| Post-connection linking for Clerk users in CheckoutSuccessPage (Solution 3) | ✅ | `src/pages/CheckoutSuccessPage.tsx:115`, `src/pages/CheckoutSuccessPage.tsx:126`, `src/pages/CheckoutSuccessPage.tsx:130` | Same race risk as above. |
| Link wallet via `/web3auth/link` and update user state using `useLinkWallet` | ✅ | `src/hooks/useLinkWallet.ts:31`, `src/hooks/useLinkWallet.ts:45`, `src/hooks/useLinkWallet.ts:48` | OK. |
| Quick Fix: detect Clerk auth via `auth_method` or Clerk token before auto-connect (Step 1) | ⚠️ | `src/hooks/useWeb3Auth.ts:183`, `src/hooks/useWeb3Auth.ts:184`, `src/hooks/useWeb3Auth.ts:96` | No Clerk token check; `auth_method` appears only set to `web3`, so Clerk sessions may not be recognized. |
| Edge case #2: Clerk user with already-linked wallet should proceed to mint without disconnect | ⚠️ | `src/components/common/Profile/PendingPassesClaim.tsx:163`, `src/hooks/useLinkWallet.ts:65`, `src/hooks/useLinkWallet.ts:71` | Already-linked wallet is treated as error and triggers disconnect, which can block claim. |
| Edge case #5: Clerk user connects wallet then refreshes should not create a new Web3 account | ❌ | `src/hooks/useWeb3Auth.ts:180`, `src/hooks/useWeb3Auth.ts:95` | With `auth_method` unset for Clerk, refresh + connected wallet can auto-login/signup as Web3, orphaning the Clerk account. |
| Scenario #4: Anonymous user connects wallet and gets Web3 signup | ✅ | `src/hooks/useWeb3Auth.ts:123`, `src/hooks/useWeb3Auth.ts:151`, `src/hooks/useWeb3Auth.ts:191` | OK. |
| No extra wallet-connect path outside intent-based flow (drift check) | ⚠️ | `src/hooks/useLinkWallet.ts:92`, `src/hooks/useLinkWallet.ts:95` | `useLinkWallet` can connect via `connectors[0]`, bypassing intent handling. |
